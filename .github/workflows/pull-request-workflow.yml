name: Pull Request Environment
on:
  pull_request:
    types: [opened]
jobs:
  deploy-to-kubernetes:
    runs-on: self-hosted
    steps:
      - name: Check Out Code
        uses: actions/checkout@v4
      - name: Deploy Kubernetes Environment
        run: |
          export PULL_REQUEST_ID=${{ github.event.pull_request.number}}
          echo $PULL_REQUEST_ID
          export RUN_SALT="pr-$PULL_REQUEST_ID-${GITHUB_RUN_ID}"
          export NAMESPACE="garion-pr-$PULL_REQUEST_ID"
          
          kubectl create namespace NAMESPACE || true

          kubectl -n NAMESPACE delete configmap blazor-web-postgres-init || true
          kubectl -n NAMESPACE create configmap blazor-web-postgres-init --from-file=init.sql

          docker build -t 144.17.92.12:5000/garion/blazor-web:$RUN_SALT .
          docker push 144.17.92.12:5000/garion/blazor-web:$RUN_SALT .

          
          for file in ./kube-pr/*; do
            echo "Applying $file"
            cat $file | envsubst | kubectl apply -f -
          done
